import fs from 'node:fs';
import path from 'node:path';

const repoRoot = process.cwd();

const read = (file) => fs.readFileSync(path.join(repoRoot, file), 'utf8');

function getTitleAndSummary(file) {
  const lines = read(file).split(/\r?\n/);
  const title = (lines.find((line) => line.startsWith('# ')) || '').replace(/^#\s+/, '').trim();
  let summary = '';

  for (const raw of lines) {
    const line = raw.trim();
    if (!line || line.startsWith('#')) continue;
    summary = line.replace(/^\*\*Goal:\*\*\s*/, '');
    break;
  }

  return { title, summary };
}

function parseIdeaOrderTable() {
  const rows = read('docs-ideas/IMPLEMENTATION-ORDER.md')
    .split(/\r?\n/)
    .filter((line) => /^\|\s*\*\*\d+\*\*/.test(line));

  const map = new Map();
  for (const row of rows) {
    const cols = row.split('|').map((col) => col.trim());
    const number = Number(cols[1].replace(/\*/g, ''));
    map.set(number, {
      name: cols[2],
      rationale: cols[4],
    });
  }
  return map;
}

function parseFeatureEpics() {
  return read('docs-ideas/BACKLOG-BY-EPIC.md')
    .split(/\r?\n/)
    .filter((line) => /^\|\s*(\*\*)?E\d+/.test(line))
    .map((line) => {
      const cols = line.split('|').map((col) => col.trim());
      return {
        epic: cols[1].replace(/\*/g, ''),
        name: cols[2].replace(/\*\*/g, ''),
        features: cols[3],
        scope: cols[4],
      };
    });
}

function parseTechRows() {
  return read('docs-tech-ideas/IMPLEMENTATION-ORDER.md')
    .split(/\r?\n/)
    .filter((line) => /^\|\s*\*\*T\d+\*\*/.test(line))
    .map((line) => {
      const cols = line.split('|').map((col) => col.trim());
      return {
        tech: cols[1].replace(/\*/g, ''),
        name: cols[2],
        doc: cols[3],
        when: cols[4],
        deps: cols[5],
      };
    });
}

function listNumberedDocs(dir) {
  return fs.readdirSync(path.join(repoRoot, dir)).filter((f) => /^\d{2}-.*\.md$/.test(f)).sort();
}

function epicForFeature(epics, n) {
  for (const epic of epics) {
    const nums = (epic.features.match(/\d+/g) || []).map(Number);
    if (nums.includes(n)) return epic.epic;
  }
  return 'TBD';
}

function buildLinearDraft() {
  const ideas = parseIdeaOrderTable();
  const epics = parseFeatureEpics();
  const techRows = parseTechRows();
  const ideaDocs = listNumberedDocs('docs-ideas');

  let out = '# Linear Migration Drafts\n\n';
  out += 'Generated by `node scripts/generate-roadmap-ticket-drafts.mjs`.\n\n';
  out += '## Feature epics (E0–E15)\n\n';

  for (const epic of epics) {
    out += `### ${epic.epic}: ${epic.name}\n`;
    out += `- Scope: ${epic.scope}\n`;
    out += `- Features: ${epic.features}\n`;
    out += '- Source: `docs-ideas/BACKLOG-BY-EPIC.md`\n\n';
  }

  out += '## Feature issues (1–28)\n\n';
  for (const doc of ideaDocs) {
    const n = Number(doc.slice(0, 2));
    const info = getTitleAndSummary(`docs-ideas/${doc}`);
    const tableInfo = ideas.get(n) || { name: info.title, rationale: 'See docs-ideas/IMPLEMENTATION-ORDER.md' };

    out += `### Idea ${n}: ${tableInfo.name}\n`;
    out += `- Parent epic: ${epicForFeature(epics, n)}\n`;
    out += `- Summary: ${info.summary || 'Fill from source doc.'}\n`;
    out += `- Rationale / value: ${tableInfo.rationale}\n`;
    out += '- Acceptance criteria / deliverables: pull “What we build”, “Phases”, and dependencies into checklist items.\n';
    out += `- Source doc: [docs-ideas/${doc}](../docs-ideas/${doc})\n`;
    out += '- Clarification follow-ups: [docs-ideas/IDEA-CLARIFICATION-QUESTIONS.md](../docs-ideas/IDEA-CLARIFICATION-QUESTIONS.md)\n\n';
  }

  out += '## Tech epics/issues (T1–T6 + T7 engine)\n\n';
  for (const row of techRows) {
    const info = getTitleAndSummary(`docs-tech-ideas/${row.doc}`);
    out += `### ${row.tech}: ${row.name}\n`;
    out += `- Goals & phases summary: ${info.summary || 'Fill from source doc.'}\n`;
    out += `- Timing: ${row.when}\n`;
    out += `- Feature dependencies: ${row.deps}\n`;
    out += '- Concrete task checklist: infra, security, data model/migrations, testing, observability, rollout/docs.\n';
    out += `- Source doc: [docs-tech-ideas/${row.doc}](../docs-tech-ideas/${row.doc})\n`;
    out += '- Clarification follow-ups: [docs-tech-ideas/TECH-CLARIFICATION-QUESTIONS.md](../docs-tech-ideas/TECH-CLARIFICATION-QUESTIONS.md)\n\n';
  }

  out += '### T7: Earn-rate matrix and spend optimizer engine\n';
  out += '- Goals & phases summary: technical engine supporting idea 27 optimization and valuation logic.\n';
  out += '- Timing: after T1–T6 baseline, before full launch of optimizer UI.\n';
  out += '- Feature dependencies: 26, 27.\n';
  out += '- Concrete task checklist: model inputs, calculation service, API endpoints, benchmark tests, observability dashboards.\n';
  out += '- Source doc: [docs-tech-ideas/07-earn-rate-matrix-and-spend-optimizer.md](../docs-tech-ideas/07-earn-rate-matrix-and-spend-optimizer.md)\n';
  out += '- Clarification follow-ups: [docs-tech-ideas/TECH-CLARIFICATION-QUESTIONS.md](../docs-tech-ideas/TECH-CLARIFICATION-QUESTIONS.md)\n';

  fs.writeFileSync(path.join(repoRoot, 'roadmap-migration/linear-migration-drafts.md'), out);
}

function inferLinearRef(file) {
  const map = [
    ['CARD-PIPELINE', 'E7 / Ideas 21–23'],
    ['BONUS-VALUE-TRACKING', 'E7 / Idea 22'],
    ['AI-BONUS-PLAN', 'E12 / Idea 24'],
    ['JUMBOTRON', 'E7'],
    ['CRAWL-BONUS-LEVELS', 'E7'],
    ['MOCK-CARDS', 'E0 or E7'],
  ];
  const hit = map.find(([needle]) => file.includes(needle));
  return hit ? hit[1] : 'TBD during migration triage';
}

function buildGithubDraft() {
  const docs = fs.readdirSync(path.join(repoRoot, 'docs')).filter((f) => f.endsWith('.md')).sort();
  let out = '# GitHub Implementation Issue Drafts\n\n';
  out += 'Generated by `node scripts/generate-roadmap-ticket-drafts.mjs`.\n\n';

  for (const doc of docs) {
    const { title, summary } = getTitleAndSummary(`docs/${doc}`);
    out += `## ${title || doc}\n`;
    out += `- Suggested issue title: Implement ${title || doc.replace(/\.md$/, '')}\n`;
    out += `- Summary/context: ${summary || 'See source doc for details.'}\n`;
    out += `- Linked Linear epic/issue: ${inferLinearRef(doc)}\n`;
    out += `- Source doc: [docs/${doc}](../docs/${doc})\n\n`;
    out += 'Checklist:\n';
    out += '- [ ] Backend changes\n';
    out += '- [ ] Frontend changes\n';
    out += '- [ ] Data model / migrations\n';
    out += '- [ ] Tests / docs updates\n\n';
  }

  fs.writeFileSync(path.join(repoRoot, 'roadmap-migration/github-implementation-issue-drafts.md'), out);
}

buildLinearDraft();
buildGithubDraft();
console.log('Generated roadmap migration drafts in roadmap-migration/.');
